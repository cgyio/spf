/**
    ScssPhp v1.12.1 编译器 补丁
    
    * !! 常用 scss 方法编译器原生支持情况，以及打补丁情况：
    * !!                    支持情况            补丁方法名              扩展方法名
    类型转换方法：
    type-of                 支持                                      isa|noa|is-numeric|is-digit|to-digit
                                                                     is-str|is-num|is-list|is-map|is-null|is-color|is-bool|is-exmap
                                                                     is-empty
    to-string               原生不支持           to-string
    to-number               原生不支持           to-number             to-strings|to-numbers
                                                                    to-comparable-numbers|to-unitless-numbers
                                                                    to-hex|to-dec

    表达式语法支持：
    if(true, v, else)       支持
    100 * 1px               支持
    100 * 1#{$u}            不支持              使用 set-unit
    '100px' * 1             不支持              使用 set-unit
    100px *|/ 2             支持
    100px / 2px             不支持
    100px + 2px             支持
    2#{$u} +|-|*|/ 5#{$u}   不支持              使用 set-unit
    100px + ''              支持

    string 字符串处理：
    quote|unquote           支持
    str-insert              支持
    str-index               支持                                        str-has|str-has-no
    str-length              支持
    str-slice               支持
    str-split               不支持              str-split
    str-replace             不支持              str-replace
    str-trim                不支持              str-trim
    to-upper-case           不支持              to-upper-case           str-upper|str-ucfirst|str-camel
    to-lower-case           不支持              to-lower-case           str-lower|str-lcfirst|str-kebab
    unique-id               支持

    number 数值处理 以及 math 数学运算方法：
    unit|unitless           支持                                        strip-unit|set-unit
    ceil|floor              支持                                        ex-ceil|ex-floor
    round                   支持                                        ex-round
    abs                     支持                                        ex-abs
    pow                     不支持              pow                     add|dif|mul|div
    clamp                   不支持              ex-clamp
    min|max                 不支持              min|max
    comparable              支持                                        ex-comparable
    math:$e|$pi             不支持

    color 颜色处理：
    rgb|rgba(#fff|r,g,b,a)  支持                                        ex-color|cmap-***
    hsl|hsla(h,s,l,a)       支持
    hsl|hsla(#fff)          不支持
    lighten|darken          支持                                        color-shifter|ex-lighten|ex-darken|color-shift-mapper
    scale-color             支持
    change-color            支持
    mix                     支持
    contrast 计算前景色      不支持                                       front|luma
    invert                  支持 反色
    adjust-hue              支持 调节色相环角度
    saturate|desaturate     支持 增加|减少 饱和度
    transparentize          支持 增加透明度
    opaquer                 不支持
    fade-out|fade-in        支持 增加|减少 透明度

    list 数组处理：
    length                  支持
    list-separator          支持
    nth|set-nth             支持                                        del-nth|slice|remove
    append                  支持                                        ex-append|mk|insert
    prepend                 不支持              prepend
    is-bracketed            支持
    index                   支持                                        has|has-no|slice
    join                    支持                                        implode
    flatten                 不支持

    map 处理：
    map-length              不支持              map-length
    map-get                 支持
    map-set                 不支持              使用 exmap-set
    map-remove              支持
    map-merge               支持
    map-has-key             支持
    map-keys|values         支持

    扩展 exmap 类型
    exmap-from
    exmap-mk
    exmap-length            支持
    exmap-get               支持
    exmap-set               支持
    exmap-remove            支持
    exmap-merge             支持
    exmap-has-key           支持
    exmap-keys|values       支持
    exmap-filter-keys       支持





**/

//scss 支持的 数据类型，增加 exmap
$scssTypeList: string,number,color,bool,list,map,function,'null',exmap;
//scss 支持的 unit 单位 map 用于 set-unit
$unitMap: (
    cm:     1cm,
    mm:     1mm,
    in:     1in,
    px:     1px,
    pt:     1pt,
    pc:     1pc,
    q:      1q,
    em:     1em,
    rem:    1rem,
    ex:     1ex,
    ch:     1ch,
    vw:     1vw,
    vh:     1vh,
    vmin:   1vmin,
    vmax:   1vmax,
    //!! %:    1%,  非法键名，使用 pec 代替 %
    pec:    1%,
    fr:     1fr,
    cap:    1cap,
    ic:     1ic,
    lh:     1lh,
    rlh:    1rlh,
    s:      1s,
    deg:    1deg,
);
//list 默认 separator comma
$dftListSeparator: comma;



/** 类型转换 **/
//isa 简写 type-of($var) == 'foo' 返回：bool
@function isa($var, $type) {
    @if type-of($type) != 'string' or index($scssTypeList, $type) == null {@return false;}

    //exmap 类型判断
    @if $type == exmap {
        @if type-of($var) != 'list' or length($var) != 2 {@return false;}
        $keys: nth($var, 1);
        $vals: nth($var, 2);
        @return is-list($keys) and is-list($vals) and length($keys) == length($vals);
    }

    @return type-of($var) == $type;
}
@function noa($var, $type) {
    @return isa($var, $type) != true;
}
//快捷判断类型
@function is-str($var)  {@return isa($var, string)  == true;}
@function is-num($var)  {@return isa($var, number)  == true;}
@function is-list($var) {@return isa($var, list)    == true;}
@function is-map($var)  {@return isa($var, map)     == true;}
@function is-null($var) {@return isa($var, 'null')  == true;}
@function is-bool($var) {@return isa($var, bool)    == true;}
@function is-color($var){@return isa($var, color)   == true;}
@function is-exmap($var){@return isa($var, exmap)   == true;}
@function no-str($var)  {@return noa($var, string)  == true;}
@function no-num($var)  {@return noa($var, number)  == true;}
@function no-list($var) {@return noa($var, list)    == true;}
@function no-map($var)  {@return noa($var, map)     == true;}
@function no-null($var) {@return noa($var, 'null')  == true;}
@function no-bool($var) {@return noa($var, bool)    == true;}
@function no-color($var){@return noa($var, color)   == true;}
@function no-exmap($var){@return noa($var, exmap)   == true;}
//判断是否 空 list|map|exmap 返回：bool
@function is-empty($list) {
    @if is-exmap($list) {
        @return exmap-is-empty($list);
    }
    @if is-list($list) {
        @return length($list) <= 0;
    }
    @if is-map($list) {
        @return map-length($list) <= 0;
    }
    @return false;
}
//is-digit 判断 string 是否完全由 0-9.- 纯数字组成 返回：bool
@function is-digit($str) {
    @if is-num($str) {
        $str: to-string($str);
    }
    @if no-str($str) or $str == '' or $str == '.' or $str == '-' or $str == '-.' {@return false;}
    $nl: ('0','1','2','3','4','5','6','7','8','9');
    @if str-length($str) == 1 {
        @return index($nl, $str) != null;
    }
    $minus: false;
    $dot: false;
    @for $i from 1 through str-length($str) {
        $ch: str-slice($str, $i, $i);
        @if $ch == '-' {
            //- 负数符号仅允许在第 1 位，且只能有 1 个
            @if $i != 1 or $minus == true {
                @return false;
            } @else {
                $minus: true;
            }
        } @else if $ch == '.' {
            //只允许 1 个小数点
            @if $dot == true {
                @return false;
            } @else {
                $dot: true;
            }
        } @else if index($nl, $ch) == null {
            @return false;
        }
    }
    @return true;
}
//to-digit 将 0-9.- 数字字符组成的字符串 转为 number 返回：number|null
@function to-digit($str) {
    @if is-digit($str) != true {@return null;}
    @if is-num($str) {
        $str: to-string($str);
    }
    $nl: ('0','1','2','3','4','5','6','7','8','9');
    $vl: (0,1,2,3,4,5,6,7,8,9);
    $len: str-length($str);
    @if $len == 1 {
        @return nth($vl, index($nl, $str));
    }
    //标记 - 负数
    $is-minus: str-slice($str, 1, 1) == '-';
    @if $is-minus {
        $str: str-slice($str, 2, $len);
        $len: $len - 1;
    }
    //.3 --> 0.3
    @if str-slice($str, 1, 1) == '.' {
        $str: '0' + $str;
    }
    //3. --> 3.0
    @if str-slice($str, $len, $len) == '.' {
        $str: $str + '0';
    }
    //不含 . 
    @if str-index($str, '.') == null {
        $num: 0;
        @for $i from 1 through $len {
            $dig: to-digit(str-slice($str, $i, $i));
            // 105 = 1 * pow(10, 2) + 0 * pow(10, 1) + 5 * pow(10, 0)
            $num: $num + $dig * pow(10, $len - $i);
        }
        @return if($is-minus, $num * -1, $num);
    }
    //包含 . 数字字符串拆为 整数部分 和 小数部分
    $nstrs: str-split($str, '.');
    $nsl: length($nstrs);
    @if $nsl > 2 or $nsl < 1 {@return null;}
    $int: to-digit(nth($nstrs, 1));
    @if no-num($int) {@return null;}
    @if $nsl == 1 {@return if($is-minus, $int * -1, $int);}
    $flo-str: nth($nstrs, 2);
    $flo-int: to-digit($flo-str);
    @if no-num($flo-int) {@return null;}
    $flo: $flo-int / pow(10, str-length($flo-str));
    $num: $int + $flo;
    @return if($is-minus, $num * -1, $num);
}
//is-numeric 判断 是否 纯数字(整数、小数)|带单位数值 形式的 string 返回：number|false
@function is-numeric($str: null, $conv: false) {
    @if no-str($str) {@return false;}
    $len: str-length($str);
    $num-str: '';
    $unit: '';
    $minus: false;
    $dot: false;
    @for $i from 1 through $len {
        $ch: str-slice($str, $i, $i);
        @if $ch == '-' or $ch == '.' or is-digit($ch) {
            @if $ch == '-' {
                @if $i != 1 or $minus == true {
                    //负号只能在首位，且只能有 1 个
                    @return false;
                } @else {
                    $minus: true;
                }
            } @else if $ch == '.' {
                @if $dot == true {
                    //只允许有 1 个 .
                    @return false;
                } @else {
                    $dot: true;
                }
            } @else {
                @if $unit != '' {
                    //在 单位后 还有数字，返回 false
                    @return false;
                }
            }
            $num-str: $num-str + $ch;
        } @else {
            @if $num-str == '' {
                //字符串首位 非数字，返回 false
                @return false;
            }
            $unit: $unit + $ch;
        }
    }
    @if $conv == debug {
        @return ($num-str, $unit);
    }
    //不包含任何数字
    @if $num-str == '' {@return false;}
    //将数字字符串转为 number
    $num: to-digit($num-str);
    @if $num == null {@return false;}
    //$conv = true 返回转换后的 number
    @if $conv == true {
        @if $unit == '' {@return $num;}
        //合并 unit 返回 number
        @return set-unit($num, $unit);
    } @else {
        @return true;
    }
}
//判断 $str 是否合法的 hex 十六进制数 支持负数和 . 自动转换类型 返回：bool
@function is-hex($hex) {
    @if is-num($hex) {
        $n: to-string($hex);
        @if is-digit($n) {
            $hex: to-string($hex);
        } @else {
            @return false;
        }
    }
    @if no-str($hex) or $hex == '' or $hex == '#' or $hex == '.' or $hex == '-' or $hex == '-.' {@return false;}
    $ls: '0123456789abcdef';
    $hex: str-lower($hex);
    @if str-slice($hex, 1, 1) == '#' {
        $hex: str-slice($hex, 2);
    }
    $len: str-length($hex);
    $minus: false;
    $dot: false;
    @for $i from 1 through $len {
        $ch: str-slice($hex, $i, $i);
        @if $ch == '-' {
            @if $i != 1 or $minus == true {
                @return false;
            } @else {
                $minus: true;
            }
        } @else if $ch == '.' {
            @if $dot == true {
                @return false;
            } @else {
                $dot: true;
            }
        } @else {
            @if str-has-no($ls, $ch) {
                @return false;
            }
        }
    }
    @return true;
}
//to-string 任意值转为 string 返回：string|null
//!! 不支持 $escape 参数
@function to-string($var, $escape: auto) {
    @if $var == null {@return null;}
    $tp: type-of($var);
    @if $tp == 'string' {@return $var;}
    @return '#{$var}';
}
//to-number 任意值转为 number 返回：number|null
@function to-number($var) {
    @if $var == null {@return null;}
    $tp: type-of($var);
    @if $tp == 'number' {@return $var;}
    @if $tp == 'bool' {
        @return if($var == true, 1, 0);
    }
    @if $tp != 'string' {@return null;}
    $num: is-numeric($var, true);
    @if $num == false {@return null;}
    @return $num;
}
//to-strings 将任意多个值 转为 string 只要有一个失败 则返回 null 全部成功则返回 顺序一致的 list
@function to-strings($vars...) {
    @if length($vars) <= 0 {@return ();}
    $strs: ();
    @each $i in $vars {
        $ni: to-string($i);
        @if is-null($ni) {@return null;}
        $strs: ex-append($strs, $ni);
    }
    @return $strs;
}
//to-numbers 将任意多个值 转为 number 只要有一个失败 则返回 null 全部成功则返回 顺序一致的 list
@function to-numbers($vars...) {
    @if length($vars) <= 0 {@return ();}
    $nums: ();
    @each $i in $vars {
        $ni: to-number($i);
        @if is-null($ni) {@return null;}
        $nums: ex-append($nums, $ni);
    }
    @return $nums;
}
//to-comparable-numbers 转换任意多个值为 number 且必须 comparable 成功返回 list 否则返回 null
@function to-comparable-numbers($vars...) {
    $nums: to-numbers($vars...);
    @if is-null($nums) {@return null;}
    @if ex-comparable($nums...) != true {@return null;}
    @return $nums;
}
//to-unitless-numbers 转换任意多个值为 纯数字 number 成功返回 list 否则返回 null
@function to-unitless-numbers($vars...) {
    $nums: to-numbers($vars...);
    @if is-null($nums) {@return null;}
    $ns: ();
    @each $i in $nums {
        $ns: ex-append($ns, strip-unit($i));
    }
    @return $ns;
}
//to-dec 十六进制字符 转 十进制 number 支持负数和 . 自动转换类型 返回：number|null
@function to-dec($hex) {
    @if is-hex($hex) != true {@return null;}
    @if is-num($hex) {
        $hex: to-string($hex);
    }
    $hex: str-lower($hex);
    $ls: '0123456789abcdef';
    $nl: (0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15);
    $len: str-length($hex);
    @if $len == 1 {
        @return nth($nl, str-index($ls, $hex));
    }
    //去除首位 #
    @if str-slice($hex, 1, 1) == '#' {
        $hex: str-slice($hex, 2, $len);
        $len: $len - 1;
    }
    //标记负数
    $is-minus: str-slice($hex, 1, 1) == '-';
    @if $is-minus {
        $hex: str-slice($hex, 2, $len);
        $len: $len - 1;
    }
    //不含 . 
    @if str-has-no($hex, '.') {
        $num: 0;
        @for $i from 1 through $len {
            $dig: to-dec(str-slice($hex, $i, $i));
            // ff = 15 * pow(16, 1) + 15 * pow(16, 0)
            $num: $num + $dig * pow(16, $len - $i);
        }
        @return if($is-minus, $num * -1, $num);
    }
    //TODO: 处理十六进制 小数

}
//to-hex 十进制数 转 十六进制字符串 支持负数 自动类型转换 返回：string|null
@function to-hex($dec) {
    @if is-str($dec) {
        $dec: to-number($dec);
    }
    @if no-num($dec) or is-digit($dec) != true {@return null;}
    @if $dec == 0 {@return '0';}

    //标记负数
    $is-minus: $dec < 0;
    @if $is-minus {
        $dec: abs($dec);
    }

    $ls: '0123456789abcdef';
    $nl: (0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15);

    //确定位数，支持 8 位十六进制数
    $digs: 0;
    @for $i from 1 through 8 {
        @if $digs == 0 and pow(16, $i) > $dec {
            $digs: $i;
        }
    }
    @if $digs == 0 {
        //超过支持位数
        @return null;
    }

    //1 位
    @if $digs == 1 {
        $idx: index($nl, $dec);
        @if is-null($idx) {
            @return null;
        } @else {
            $hexi: str-slice($ls, $idx, $idx);
            @return if($is-minus, '-' + $hexi, $hexi);
        }
    }

    //循环除以 16 直到 商 < 16
    //商
    $left: $dec;
    //余数  --> 当前位的数值 0~15
    $quos: ();
    @for $i from 1 through $digs {
        $quo: $left % 16;
        $left: floor($left / 16);
        $quos: prepend($quos, $quo);
    }
    
    //依次将每一位的数值 转为 十六进制字符
    $ts: '';
    @each $i in $quos {
        $idx: index($nl, $i);
        @if is-null($idx) or (is-num($idx) and $idx > 16) {
            @return null;
        } @else {
            $hexi: str-slice($ls, $idx, $idx);
            $ts: $ts + $hexi;
        }
    }
    @return if($is-minus, '-' + $ts, $ts);
}



/** string 字符串处理 **/
//str-has 判断是否包含字符 自动转换类型 返回：bool
@function str-has($string, $search) {
    $strs: to-strings($string, $search);
    @if is-null($strs) {@return false;}
    @return str-index(nth($strs, 1), nth($strs, 2)) != null;
}
@function str-has-no($string, $search) {
    @return str-has($string, $search) != true;
}
//str-split 使用 $separator 分割字符串 自动转换类型 返回：list|null
@function str-split($string, $separator: space) {
    $strs: to-strings($string, $separator);
    @if is-null($strs) {@return mk('','');}
    $string: nth($strs, 1);
    $separator: nth($strs, 2);
    $sep: $separator;
    @if $separator == space {$sep: ' ';}
    @if $separator == comma {$sep: ',';}
    $len: str-length($string);
    $plen: str-length($sep);
    @if $len <= 0 {@return mk('');}
    @if $plen <= 0 {
        //空字符串分割，
        $list: ();
        @for $i from 1 through $len {
            $list: ex-append($list, str-slice($string, $i, $i));
        }
        @return $list;
    }
    @if $len < $plen {@return mk($string);}
    @if $len == $plen {
        @if $string == $sep {
            @return mk('','');
        } @else {
            @return mk($string);
        }
    }

    $idx: str-index($string, $sep);
    @if $idx == null {
        @return mk($string);
    }
    $list: ();
    @if $idx > 1 {
        $list: ex-append($list, str-slice($string, 1, $idx - 1));
    }
    @if $idx + $plen - 1 < $len {
        $sub-str: str-slice($string, $idx + $plen, $len);
        $sub-list: str-split($sub-str, $separator);
        @if is-null($sub-list) {@return null;}
        $list: join($list, $sub-list, $dftListSeparator);
    }
    @return $list;
}
//str-replace 替换字符串 递归替换所有找到的 search 自动转换类型 返回：string
@function str-replace($string, $search, $replace) {
    $strs: to-strings($string, $search, $replace);
    @if is-null($strs) {@return $string;}
    $string: nth($strs, 1);
    $search: nth($strs, 2);
    $replace: nth($strs, 3);
    $len: str-length($string);
    $slen: str-length($search);
    @if $len < $slen {@return $string;}
    $idx: str-index($string, $search);
    @if $idx == null {@return $string;}
    $nstr-a: if($idx == 1, '', str-slice($string, 1, $idx - 1));
    @if $len - $idx - $slen + 1 >= $slen {
        //剩余字符串长度 >= search 字符串长度，递归调用
        $nstr-b: str-replace(str-slice($string, $idx + $slen, $len), $search, $replace);
    } @else {
        //剩余字符串长度 < search 字符串长度，直接截取剩余的部分
        $nstr-b: if($idx + $slen == $len + 1, '', str-slice($string, $idx + $slen, $len));
    }
    @return $nstr-a + $replace + $nstr-b + '';
}
//str-trim 去除字符串首尾的 空格 或 $search 自动类型转换 返回：string
@function str-trim($string, $search: ' ') {
    $strs: to-strings($string, $search);
    @if is-null($strs) {@return $string;}
    $string: nth($strs, 1);
    $search: nth($strs, 2);
    @if str-has-no($string, $search) {@return $string;}
    $len: str-length($string);
    $ts: '';
    //去除 左侧 空格 或 $search
    @for $i from 1 through $len {
        $ch: str-slice($string, $i, $i);
        @if $ch == $search {
            @if $ts != '' {
                $ts: $ts + $ch;
            }
        } @else {
            $ts: $ts + $ch;
        }
    }
    //去除 右侧 空格 或 $search
    $rtn: '';
    $tlen: str-length($ts);
    @for $i from 1 to $tlen + 1 {
        $j: $tlen - $i + 1;
        $ch: str-slice($ts, $j, $j);
        @if $ch == $search {
            @if $rtn != '' {
                $rtn: $ch + $rtn;
            }
        } @else {
            $rtn: $ch + $rtn;
        }
    }
    @return $rtn;
}
//to-upper-case|to-lower-case 自动类型转换 返回：string
@function str-case-shift($string, $upper: true) {
    $str: to-string($string);
    @if no-str($str) or str-length($string) <= 0 {@return $string;}
    $ups: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    $los: 'abcdefghijklmnopqrstuvwxyz';
    $ts: '';
    @for $i from 1 through str-length($string) {
        $ch: str-slice($string, $i, $i);
        $is-u: str-has($ups, $ch);
        $is-l: str-has($los, $ch);
        @if $is-u != true and $is-l != true {
            $ts: $ts + $ch;
        } @else {
            @if $is-u and $upper == false {
                //to-lower
                $idx: str-index($ups, $ch);
                $chi: str-slice($los, $idx, $idx);
            } @else if $is-l and $upper == true {
                //to-upper
                $idx: str-index($los, $ch);
                $chi: str-slice($ups, $idx, $idx);
            } @else {
                $chi: $ch;
            }
            $ts: $ts + $chi;
        }
    }
    @return $ts;
}
@function to-upper-case($string) {
    @return str-case-shift($string);
}
@function to-lower-case($string) {
    @return str-case-shift($string, false);
}
//to-upper|lower-case 简写方法 返回：string
@function str-upper($string) {@return to-upper-case($string);}
@function str-lower($string) {@return to-lower-case($string);}
//str-ucfirst|lcfirst 首字母 大写|小写
@function str-ucfirst($string) {
    $str: to-string($string);
    @if no-str($str) or $str == '' {@return $string;}
    $fs: str-slice($str, 1, 1);
    $rs: if(str-length($str) <= 1, '', str-slice($str, 2, str-length($str)));
    $ufs: str-upper($fs);
    @return $ufs + $rs;
}
@function str-lcfirst($string) {
    $str: to-string($string);
    @if no-str($str) or $str == '' {@return $string;}
    $fs: str-slice($str, 1, 1);
    $rs: if(str-length($str) <= 1, '', str-slice($str, 2, str-length($str)));
    $lfs: str-lower($fs);
    @return $lfs + $rs;
}
//str-camel|str-kebab 驼峰|连字符 形式字符串 返回：string
@function str-camel($string, $separator: '-') {
    $strs: str-split($string, $separator);
    @if no-list($strs) or is-empty($strs) {@return $string;}
    $ts: '';
    @each $i in $strs {
        $ui: str-ucfirst(str-lower($i));
        $ts: $ts + $ui;
    }
    @return $ts;
}
@function str-kebab($string, $separator: '-') {
    $str: to-string($string);
    @if no-str($str) or $str == '' {@return $string;}
    $str: str-lcfirst($str);
    $us: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    $ts: '';
    @for $i from 1 through str-length($str) {
        $ch: str-slice($str, $i, $i);
        @if str-has($us, $ch) {
            $ts: $ts + $separator + $ch;
        } @else {
            $ts: $ts + $ch;
        }
    }
    @return str-lower($ts);
}



/** number以及数学运算 **/
//strip-unit 将 100px 形式数值 去除单位 自动转换类型 返回：number 无单位
@function strip-unit($number) {
    $num: to-number($number);
    @if no-num($num) {@return $number;}
    $number: $num;
    @if unitless($number) {@return $number;}
    $u: unit($number);
    $num-str: $number + '';
    $num-str: str-replace($num-str, $u, '');
    @return to-digit($num-str);
}
//set-unit 替换传入的 number 的 unit 单位 自动转换类型 返回：number 带单位
@function set-unit($number, $unit) {
    $num: to-number($number);
    $unit: to-string($unit);
    @if no-num($num) or no-str($unit) {@return $number;}
    $number: $num;

    //!! % 在 $unitMap 中的键名为 pec
    @if $unit == '%' {$unit: pec;}

    $du: map-get($unitMap, $unit);
    @if $du == null {@return $number;}
    @if unit($number) == $unit {@return $number;}
    $number: strip-unit($number);
    @if $unit == '' {@return $number;}
    @return $number * $du;
}
//pow 整数次幂 自动转换类型 返回：number|null
@function pow($base, $exponent) {
    $nums: to-unitless-numbers($base, $exponent);
    @if is-null($nums) {@return null;}
    $base: nth($nums, 1);
    $exponent: nth($nums, 2);
    @if $exponent == 0 {@return 1;}
    @if $base == 0 {@return 0;}
    @if $exponent == 1 {@return $base;}
    @if $exponent == -1 {@return 1 / $base;}
    $ng: $exponent < 0;
    $pow: $base;
    $max: abs($exponent) - 1;
    @for $i from 1 through $max {
        $pow: $pow * $base;
    }
    @if $ng {
        @return 1 / $pow;
    } @else {
        @return $pow;
    }
}
//ex-comparable 扩展到多个 numbers 判断 comparable 返回：bool
@function ex-comparable($numbers...) {
    $numbers: to-numbers($numbers...);
    @if is-null($numbers) or is-empty($numbers) {@return false;}
    $len: length($numbers);
    @if $len == 1 {@return true;}
    @for $i from 1 to $len - 1 {
        $n1: nth($numbers, $i);
        $n2: nth($numbers, $i + 1);
        @if comparable($n1, $n2) != true {
            @return false;
        }
    }
    @return true;
}
//ex-clamp 确保输入的 number 在 min|max 范围内 自动转换类型 返回：number|null
@function ex-clamp($min, $number, $max) {
    $nums: to-comparable-numbers($min, $number, $max);
    @if is-null($nums) {@return null;}
    $min: nth($nums, 1);
    $number: nth($nums, 2);
    $max: nth($nums, 3);
    @return if($min > $number, $min, if($number > $max, $max, $number));
}
//min 最小值 自动转换类型 返回 number
@function min($numbers...) {
    //type-of($numbers) == arglist 可用 nth|length|@each
    $numbers: to-comparable-numbers($numbers...);
    @if is-null($numbers) or is-empty($numbers) {@return null;}
    $min: null;
    @each $ni in $numbers {
        @if no-num($min) {
            $min: $ni;
        } @else {
            //确保数值可比较
            //@if comparable($ni, $min) != true {@return null;}
            @if $ni < $min {
                $min: $ni;
            }
        }
    }
    @return $min;
}
//max 最大值 自动转换类型 返回 number
@function max($numbers...) {
    $numbers: to-comparable-numbers($numbers...);
    @if is-null($numbers) or is-empty($numbers) {@return null;}
    $max: null;
    @each $ni in $numbers {
        @if no-num($max) {
            $max: $ni;
        } @else {
            //确保数值可比较
            //@if comparable($ni, $max) != true {@return null;}
            @if $ni > $max {
                $max: $ni;
            }
        }
    }
    @return $max;
}
//扩展 加减乘除方法 add|dif|mul|div 自动转换类型 返回：number|null
@function add($numbers...) {
    $numbers: to-comparable-numbers($numbers...);
    @if is-null($numbers) or is-empty($numbers) {@return null;}
    $sum: 0;
    @each $i in $numbers {
        $sum: $sum + $i;
    }
    @return $sum;
}
@function dif($numbers...) {
    $numbers: to-comparable-numbers($numbers...);
    @if is-null($numbers) or is-empty($numbers) {@return null;}
    @if length($numbers) == 1 {@return nth($numbers, 1);}
    $diff: nth($numbers, 1);
    @for $i from 2 through length($numbers) {
        $n: nth($numbers, $i);
        $diff: $diff - $n;
    }
    @return $diff;
}
//!! 乘法|除法 会自动统一单位，使用 第一个存在的单位 作为最终结果的 单位
@function mul($numbers...) {
    $numbers: to-comparable-numbers($numbers...);
    @if is-null($numbers) or is-empty($numbers) {@return null;}
    //统一单位，只保留第一个单位
    $unit: '';
    @each $i in $numbers {
        @if $unit == '' {
            $ui: unit($i);
            @if $ui != '' {
                $unit: $ui;
            }
        }
    }
    $prod: 1;
    @each $i in $numbers {
        $ni: strip-unit($i);
        $prod: $prod * $i;
    }
    @return if($unit != '', set-unit($prod, $unit), $prod);
}
@function div($numbers...) {
    $numbers: to-comparable-numbers($numbers...);
    @if is-null($numbers) or is-empty($numbers) {@return null;}
    $len: length($numbers);
    @if $len == 1 {@return nth($numbers, 1);}
    //统一单位，只保留第一个单位
    $unit: '';
    @each $i in $numbers {
        @if $unit == '' {
            $ui: unit($i);
            @if $ui != '' {
                $unit: $ui;
            }
        }
    }
    $quo: strip-unit(nth($numbers, 1));
    @for $i from 2 through $len {
        $ni: strip-unit(nth($numbers, $i));
        $quo: $quo / $ni;
    }
    @return if($unit != '', set-unit($quo, $unit), $quo);
}
//扩展 round|ceil|floor|abs 方法 增加自动类型转换功能 返回：number
@function ex-round($number) {
    $n: to-number($number);
    @if no-num($n) {@return null;}
    @return round($n);
}
@function ex-ceil($number) {
    $n: to-number($number);
    @if no-num($n) {@return null;}
    @return ceil($n);
}
@function ex-floor($number) {
    $n: to-number($number);
    @if no-num($n) {@return null;}
    @return floor($n);
}
@function ex-abs($number) {
    $n: to-number($number);
    @if no-num($n) {@return null;}
    @return abs($n);
}



/** color 颜色处理 **/
/**
 *  ex-color 根据传入的任意 string|list 创建颜色 返回：color(hex字符串形式)|null
    修复 原生不支持 color(...) 方法的缺陷，与 原生 color 语法略有不同
    * !! 目前仅支持 rgb|hsl 色彩空间
    ex-color(#ff0)                  #ffff00
    ex-color('#ff0')                #ffff00
    ex-color('#ffff00cc')           rgba(255,255,0,0.8)
    ex-color('#ffff00', 0.8)        rgba(255,255,0,0.8)
    ex-color(255 255 255)           white
    ex-color(255 255 255, 0.5)      rgba(255,255,255,0.5)
    ex-color(hsl 0 0% 100%)         white       
    ex-color(hsl 0 0% 100%, 0.5)    rgba(255,255,255,0.5)
**/
@function ex-color($p, $alpha: 1) {
    // 透明度
    @if no-num($alpha) {$alpha: to-number($alpha);}
    $alpha: strip-unit($alpha);
    $alpha: ex-clamp(0, $alpha, 1);

    // 0 直接传入了颜色，直接转为 cmap 数据，然后返回 color(hex字符串形式)
    @if is-color($p) {
        $cmap: cmap-from($p);
        @if no-cmap($cmap) {@return null;}
        @return cmap-color($cmap);
    }
    // 1 传入了 list 
    @if is-list($p) {
        $len: length($p);
        $cfn: null;
        $color: null;
        @if $len == 3 {
            // (255 255 255) 
            $cfn: rgb;
            $r: nth($p, 1);
            $g: nth($p, 2);
            $b: nth($p, 3);
        } @else if $len == 4 and has((rgb,hsl), nth($p, 1)) {
            // (rgb 255 255 255) | (hsl 0 0% 100%)
            $np: slice($p, 2, 4);
            @if nth($p, 1) == rgb {
                $cfn: rgb;
                $r: nth($np, 1);
                $g: nth($np, 2);
                $b: nth($np, 3);
            } @else {
                $cfn: hsl;
                $h: nth($np, 1);
                $s: nth($np, 2);
                $l: nth($np, 3);
            }
        }
        @if $cfn == null {@return null;}
        @if $cfn == rgb {
            $r: ex-clamp(0, strip-unit($r), 255);
            $g: ex-clamp(0, strip-unit($g), 255);
            $b: ex-clamp(0, strip-unit($b), 255);
            //@if $alpha < 1 {
                $color: rgba($r, $g, $b, $alpha);
            //} @else {
            //    $color: rgb($r, $g, $b);
            //}
        } @else if $cfn == hsl {
            $h: ex-clamp(0, strip-unit($h), 360);
            $s: ex-clamp(0%, set-unit($s, pec), 100%);
            $l: ex-clamp(0%, set-unit($l, pec), 100%);
            $color: hsla($h, $s, $l, $alpha);
        }
        @if no-color($color) {@return null;}
        @return ex-color($color);
    }
    // 2 传入 hex 颜色字符串
    @if is-str($p) {
        $len: str-length($p);
        // 去除 开头的 #
        @if str-slice($p, 1,1) == '#' {
            $p: str-slice($p, 2, $len);
            $len: $len - 1;
        }
        //颜色字符串只能是固定的长度
        @if has((6,3,8,4), $len) != true {@return null;}
        // ff112233 | f123 含有 alpha 的颜色字符串
        @if has((8,4), $len) {
            $a-hex: if($len == 8, str-slice($p, 7, 8), str-slice($p, 4, 4));
            @if str-length($a-hex) == 1 {
                $a-hex: $a-hex + $a-hex;
            }
            //截取 颜色 hex
            @if $len == 8 {
                $p: str-slice($p, 1, 6);
                $len: 6;
            } @else {
                $p: str-slice($p, 1, 3);
                $len: 3;
            }
            //如果传入了 alpha 则使用传入的 alpha 否则计算 字符串中包含的 alpha
            @if $alpha == 1 {
                //hex --> 0~255
                $a-dec: to-dec($a-hex);
                //0~255 --> 0-1
                $alpha: ex-clamp(0, $a-dec / 255, 1);
            }
        }
        // ff1122 | f12 转换为 rgb 数值
        @if $len == 6 {
            $r-hex: str-slice($p, 1, 2);
            $g-hex: str-slice($p, 3, 4);
            $b-hex: str-slice($p, 5, 6);
        } @else {
            $r-hex: str-slice($p, 1, 1);
            $g-hex: str-slice($p, 2, 2);
            $b-hex: str-slice($p, 3, 3);
            $r-hex: $r-hex + $r-hex;
            $g-hex: $g-hex + $g-hex;
            $b-hex: $b-hex + $b-hex;
        }
        $r: ex-clamp(0, to-dec($r-hex), 255);
        $g: ex-clamp(0, to-dec($g-hex), 255);
        $b: ex-clamp(0, to-dec($b-hex), 255);
        //创建 color
        $color: rgba($r, $g, $b, $alpha);
        @if no-color($color) {@return null;}
        @return ex-color($color);
    }

    @return null;
}
//color-shifter|ex-lighten|ex-darken 通过 scale-color 加深|减淡 颜色 自动转换格式 返回：color(is-color(..) == true)
@function color-shifter($color, $level: 0, $step: 10%) {
    @if no-color($color) {$color: ex-color($color);}
    @if no-color($color) {@return null;}
    @if no-num($level) {$level: to-number($level);}
    @if no-num($level) or strip-unit($level) == 0 {@return $color;}
    @if unitless($level) {
        //无单位 level 表示 加深|减淡 级数 -10~0~10
        $step: set-unit(ex-abs($step), pec);
        $l: mul(ex-clamp(-10, $level, 10), $step);
    } @else if unit($level) == '%' {
        //% 单位表示 加深|减淡 百分比
        $l: ex-clamp(-100%, $level, 100%);
    } @else{
        //无效输入
        @return $color;
    }
    //调用 scale-color 方法
    @return scale-color($color, $lightness: $l);
}
@function ex-lighten($color, $level: 0, $step: 10%) {
    @return color-shifter($color, ex-abs($level), $step);
}
@function ex-darken($color, $level: 0, $step: 10%) {
    @return color-shifter($color, mul(ex-abs($level), -1), $step);
}
//color-shift-mapper 根据传入的 color 自动生成 $level 级数的 加深|减淡 变体 返回：exmap
//$level = 3 则生成 l3,l2,l1,m,d1,d2,d3 7 种 color
@function color-shift-mapper($color, $level: 3, $step: 10%, $key: '') {
    @if no-color($color) {$color: ex-color($color);}
    @if no-color($color) {@return null;}
    //最大支持 10 级变体
    $level: ex-clamp(0, strip-unit(ex-abs($level)), 10);
    @if no-num($level) {@return null;}
    //颜色 map 中的 键名前缀
    $key: to-string($key);
    @if no-str($key) {$key: '';}
    $pre: if($key != '', $key + '-', '');
    //空 exmap
    $map: exmap-mk();
    //0 级
    @if $level == 0 {@return exmap-set($map, $pre + 'm', $color);}
    //减淡方向 l3 -> l1
    @for $i from 1 through $level {
        $l: $level - $i + 1;
        $k: $pre + 'l' + $l;
        $v: ex-lighten($color, $l, $step);
        @if is-color($v) {
            $map: exmap-set($map, $k, $v);
        }
    }
    //原色
    $map: exmap-set($map, $pre + 'm', $color);
    //加深方向 d1 -> d3
    @for $i from 1 through $level {
        $k: $pre + 'd' + $i;
        $v: ex-darken($color, $i, $step);
        @if is-color($v) {
            $map: exmap-set($map, $k, $v);
        }
    }
    @if no-exmap($map) {@return null;}
    @return $map;
}
//luma 计算颜色的视觉亮度 返回：null|number 0~255 无单位
@function luma($color) {
    @if no-color($color) {$color: ex-color($color);}
    @if no-color($color) {@return null;}
    $cmap: cmap-from($color);
    //$luma: round(0.299*$r + 0.587*$g + 0.114*$b);
    $r: mul(cmap-get($cmap, r), 0.299);
    $g: mul(cmap-get($cmap, g), 0.587);
    $b: mul(cmap-get($cmap, b), 0.114);
    @return round(add($r, $g, $b));
}
//front 自动计算前景色 保证对比度 返回：color
@function front($color, $alpha: 1, $dark: #000000, $light: #ffffff) {
    @if no-color($color) {$color: ex-color($color);}
    @if no-color($color) {@return null;}
    $luma: luma($color);
    $fc: if($luma < 128, $light, $dark);
    @return ex-color($fc, $alpha);
}
/**
    根据传入的 color 创建一个 内部数据类型 cmap 储存 color 的所有参数

    is-exmap($cmap) == true
    $cmap: (
        //keys
        ('r','g','b','h','s','l','a'),
        //values
        (0~255, 0~255, 0~255, 0~360deg, 0~100%, 0~100%, 0~1)
    )

    所有扩展颜色方法，将基于此数据结构，进行计算
**/
//is-cmap 判断是否合法的 cmap 数据 返回：bool
@function is-cmap($cmap) {
    @if no-exmap($cmap) {@return false;}
    $ks: exmap-keys($cmap);
    @if length($ks) != 7 {@return false;};
    @if implode($ks, '') != 'rgbhsla' {@return false;}
    @return true;
}
@function no-cmap($cmap) {@return is-cmap($cmap) != true;}
//cmap-from 根据传入的 color 字符串(is-color(..) == true) 数据创建 cmap 返回：exmap|null
@function cmap-from($color: null) {
    //无传入数据，创建 #ffffff cmap
    @if is-null($color) {
        @return exmap-from((
            r: 255,
            g: 255,
            b: 255,
            h: 0deg,
            s: 0%,
            l: 100%,
            a: 1,
        ));
    }
    //传入非法字符
    @if no-color($color) {@return null;}
    //解析 color 数据，创建并返回 cmap
    @return exmap-from((
        r: ex-clamp(0,    strip-unit(red($color)),            255),
        g: ex-clamp(0,    strip-unit(green($color)),          255),
        b: ex-clamp(0,    strip-unit(blue($color)),           255),
        h: ex-clamp(0deg, set-unit(hue($color), deg),         360deg),
        s: ex-clamp(0%,   set-unit(saturation($color), pec),  100%),
        l: ex-clamp(0%,   set-unit(lightness($color), pec),   100%),
        a: ex-clamp(0,    strip-unit(alpha($color)),          1),
    ));
}
//cmap-color 将合法的 cmap 数据转换为 css 支持的 颜色字符串(is-color(..) == true) 返回：color|null
@function cmap-color($cmap) {
    @if no-cmap($cmap) {@return null;}
    $rgba: cmap-get($cmap, rgba);
    @return rgba($rgba...);
}
/**
    cmap-get 分别读取颜色参数 返回：number(如果有单位则带单位)  或 list
    cmap-get($cmap, r)          --> r
    cmap-get($cmap, rgba)       --> (r,g,b,a)
    cmap-get($cmap, lsh)        --> (l,s,h)
**/
@function cmap-get($cmap, $key: null) {
    @if no-str($key) or $key == '' {@return null;}
    @if no-cmap($cmap) {@return null;}
    $klen: str-length($key);
    @if $klen == 1 {@return exmap-get($cmap, $key);}
    $rtn: ();
    @for $i from 1 through $klen {
        $k: str-slice($key, $i, $i);
        @if exmap-has-key($cmap, $k) != true {@return null;}
        $v: exmap-get($cmap, $k);
        $rtn: ex-append($rtn, $v);
    }
    @return $rtn;
}
//cmap-filter-keys 与 cmap-get 区别是 此函数返回 exmap 类型数据
@function cmap-filter-keys($cmap, $key: null) {
    $vals: cmap-get($cmap, $key);
    @if is-null($val) {@return null;}
    @if str-length($key) == 1 {
        @return (($key),($vals));
    }
    $keys: str-split($key, '');
    @return ($keys, $vals);
}
//cmap-set |cmap-set-rgb|cmap-set-hsl|cmap-set-alpha 修改颜色，返回：exmap
@function cmap-set($cmap, $r: null, $g: null, $b: null, $h: null, $s: null, $l: null, $a: null) {
    $cmap: cmap-set-rgb($cmap, $r, $g, $b);
    $cmap: cmap-set-hsl($cmap, $h, $s, $l);
    $cmap: cmap-set-alpha($cmap, $a);
    @return $cmap;
}
@function cmap-set-rgb($cmap, $r: null, $g: null, $b: null) {
    @if no-cmap($cmap) {@return $cmap;}
    $rgba: cmap-get($cmap, rgba);
    @if no-null($r) {$r: ex-clamp(0, strip-unit($r), 255);}
    @if no-null($g) {$g: ex-clamp(0, strip-unit($g), 255);}
    @if no-null($b) {$b: ex-clamp(0, strip-unit($b), 255);}
    @if no-null($r) {$rgba: set-nth($rgba, 1, $r);}
    @if no-null($g) {$rgba: set-nth($rgba, 2, $g);}
    @if no-null($b) {$rgba: set-nth($rgba, 3, $b);}
    //新颜色
    $nc: rgba($rgba...);
    @if no-color($nc) {@return null;}
    //返回新颜色的 cmap
    @return cmap-from($nc);
}
@function cmap-set-hsl($cmap, $h: null, $s: null, $l: null) {
    @if no-cmap($cmap) {@return $cmap;}
    $hsla: cmap-get($cmap, hsla);
    @if no-null($h) {$h: ex-clamp(0deg, set-unit($h, deg), 360deg);}
    @if no-null($s) {$s: ex-clamp(0%, set-unit($s, pec), 100%);}
    @if no-null($l) {$l: ex-clamp(0%, set-unit($l, pec), 100%);}
    @if no-null($h) {$hsla: set-nth($hsla, 1, $h);}
    @if no-null($s) {$hsla: set-nth($hsla, 2, $s);}
    @if no-null($l) {$hsla: set-nth($hsla, 3, $l);}
    //新颜色
    $nc: hsla($hsla...);
    @if no-color($nc) {@return null;}
    //返回新颜色的 cmap
    @return cmap-from($nc);
}
@function cmap-set-alpha($cmap, $a: null) {
    @if no-cmap($cmap) {@return $cmap;}
    $rgba: cmap-get($cmap, rgba);
    @if no-null($a) {$a: ex-clamp(0, strip-unit($a), 1);}
    @if no-null($a) {$rgba: set-nth($rgba, 4, $a);}
    //新颜色
    $nc: rgba($rgba...);
    @if no-color($nc) {@return null;}
    //返回新颜色的 cmap
    @return cmap-from($nc);
}



/** list 数组处理 **/
//index() != null 的简写 返回：bool
@function has($list, $value) {
    @if no-list($list) {@return false;}
    @return index($list, $value) != null;
}
@function has-no($list, $value) {
    @return has($list, $value) != true;
}
//ex-append 覆盖默认 append 方法支持插入 list 返回：list
@function ex-append($list, $value, $separator: $dftListSeparator) {
    @if no-list($list) {@return $list;}
    $sep: if(is-empty($list), $separator, list-separator($list));
    $bra: is-bracketed($list);
    @if is-list($value) {
        @return join($list, $value, $sep, $bra);
    } @else {
        @return append($list, $value, $sep);
    }
}
//mk 直接通过 不定参数 创建一个 list 返回：list
@function mk($values...) {
    @if length($values) <= 0 {@return ();}
    $list: ();
    @each $i in $values {
        $list: ex-append($list, $i, $dftListSeparator);
    }
    @return $list;
}
//prepend 向 list 头部插入元素 支持插入 list 返回：list
@function prepend($list, $value, $separator: $dftListSeparator) {
    @if no-list($list) {@return $list;}
    $sep: if(is-empty($list), $separator, list-separator($list));
    $bra: is-bracketed($list);
    @if is-list($value) {
        $pre: $value;
    } @else {
        $pre: append((), $value, $sep);
    }
    @return join($pre, $list, $sep, $bra);
}
//del-nth 从 list 删除某个 index 支持负 index 返回：list
@function del-nth($list, $index, $separator: $dftListSeparator) {
    @if no-list($list) or no-num($index) {@return $list;}
    $len: length($list);
    $sep: if(is-empty($list), $separator, list-separator($list));
    $bra: is-bracketed($list);
    @if $len <= 0 {@return $list;}
    @if $index < 0 {$index: $index + $len + 1;}
    $i: ex-clamp(1, $index, $len);
    $la: if($index == 1, (), slice($list, 1, $index - 1));
    $lb: if($index == $len, (), slice($list, $index + 1, $len));
    @return join($la, $lb, $sep, $bra);

}
//slice 切片 list 支持负 index 返回：list
@function slice($list, $start, $end: 0, $separator: $dftListSeparator) {
    @if no-list($list) {@return $list;}
    @if no-num($start) or no-num($end) {@return $list;}
    $len: length($list);
    $sep: if(is-empty($list), $separator, list-separator($list));
    $bra: is-bracketed($list);
    @if $len <= 0 {@return ();}
    @if $start == 0 and $end == 0 {@return ();}
    @if $start <= 0 {$start: $start + $len + 1;}
    @if $end <= 0 {$end: $end + $len + 1;}
    $start: ex-clamp(1, $start, $len);
    $end: ex-clamp(1, $end, $len);
    @if $start > $end {
        $t: $end;
        $end: $start;
        $start: $t;
    }
    $rtn: ();
    @for $i from $start through $end {
        $rtn: join($rtn, nth($list, $i), $sep, $bra);
    }
    @return $rtn;
}
//insert 向 list 指定 index 插入元素 支持负 index 支持插入 list 返回：list
@function insert($list, $insert, $index, $separator: $dftListSeparator) {
    @if no-list($list) or no-num($index) {@return $list;}
    $len: length($list);
    $sep: if(is-empty($list), $separator, list-separator($list));
    $bra: is-bracketed($list);
    @if $index < 0 {$index: $index + $len;}
    $index: ex-clamp(0, $index, $len);
    
    $list-a: if($index == 0, (), slice($list, 1, $index));
    $list-b: if($index == $len, (), slice($list, $index + 1, $len));

    @if is-list($insert) {
        $rtn: join($list-a, $insert, $sep, $bra);
    } @else {
        $rtn: append($list-a, $insert, $sep);
    }
    @if length($list-b) > 0 {
        $rtn: join($rtn, $list-b, $sep, $bra);
    }
    @return $rtn;
}
//remove 从 list 中删除元素 支持传入多个要删除的元素组成的 list 返回：list
@function remove($list, $remove, $separator: $dftListSeparator) {
    @if no-list($list) {@return $list;}
    $len: length($list);
    $sep: if(is-empty($list), $separator, list-separator($list));
    $bra: is-bracketed($list);
    @if $len <= 0 {@return $list;}
    @if is-list($remove) {
        @each $i in $remove {
            @if has($list, $i) {
                $list: remove($list, $i, $sep);
            }
        }
        @return $list;
    } @else {
        $index: index($list, $remove);
        @if no-null($index) {
            @return del-nth($list, $index, $sep);
        }
        @return $list;
    }
}
//implode 类似 js array.join() 返回：string
@function implode($list, $glue: '-') {
    @if no-list($list) {@return $list;}
    @if is-empty($list) {@return '';}
    $ts: '';
    @each $i in $list {
        $si: to-string($i);
        @if no-str($si) {
            $si: 'null';
        }
        @if $ts == '' {
            $ts: $si;
        } @else {
            $ts: $ts + $glue + $si;
        }
    }
    @return $ts;
}



/** map 处理 **/
//map-length 返回：number|null
@function map-length($map) {
    @if no-map($map) {@return null;}
    @return length(map-keys($map));
}



/**
  * !! ScssPhp 库不支持 map-set 无法动态创建|修改原生 map 因此定义一个 exmap 类型 

    type-of($ex-map) == 'list'
    isa($ex-map, exmap) == true
    is-exmap($ex-map) == true

    $ex-map: (
        //keys list
        ('padding', 'margin', 'font-size'),
        //values list
        (12px, 8px, 14px)
    )
    exmap-get($ex-map|$map, padding)                --> 12px
    exmap-remove($ex-map|$map, padding)             --> $ex-map
    exmap-set($ex-map|$map, padding, 16px)          --> $ex-map
    exmap-from($map|$ex-map)                        --> $ex-map
    exmap-merge($ex-map|$map, $ex-map|$map)         --> $ex-map
    exmap-filter($ex-map|$map, $keys-list)          --> $ex-map
**/
//exmap-length 
@function exmap-length($map) {
    @if is-map($map) {
        @return map-length($map);
    }
    @if no-exmap($map) {@return null;}
    @return length(exmap-keys($map));
}
//判断一个 exmap 是否为空 返回：bool
@function exmap-is-empty($exmap: null) {
    $exmap: exmap-from($exmap);
    $keys: exmap-keys($exmap);
    @return length($keys) <= 0;
}
//判断是否存在 key 键 返回：bool
@function exmap-has-key($exmap: null, $key: null) {
    @return exmap-index($exmap, $key) != null;
}
//exmap-quote 将 exmap 中所有 keys 键名都应用一次 quote 转为带引号 键名
@function exmap-quote($exmap: null) {
    @if no-exmap($exmap) {@return $exmap;}
    $keys: exmap-keys($exmap);
    $vals: exmap-values($exmap);
    $nkeys: ();
    @each $i in $keys {
        $nkeys: ex-append($nkeys, quote($i));
    }
    @return ($nkeys, $vals);
}
//创建一个空 exmap 返回：exmap
@function exmap-mk() {
    @return ((), ());
}
//根据 map 类型数据，创建 exmap 返回：exmap
@function exmap-from($map) {
    @if is-exmap($map) {@return $map;}
    @if no-map($map) {@return exmap-mk();}
    $ks: map-keys($map);
    $keys: ();
    $vals: ();
    @each $k in $ks {
        $v: map-get($map, $k);
        @if $v != null {
            $keys: ex-append($keys, $k);
            $vals: ex-append($vals, $v);
        }
    }
    @return exmap-quote(($keys, $vals));
}
//exmap-index 查找 key 对应的 index
@function exmap-index($exmap, $key) {
    @if no-exmap($exmap) or no-str($key) or $key == '' {@return null;}
    $keys: exmap-keys($exmap);
    @return index($keys, quote($key));
}
/** exmap-keys **/
@function exmap-keys($exmap) {
    @if no-exmap($exmap) {@return ();}
    @return nth($exmap, 1);
}
/** exmap-values **/
@function exmap-values($exmap) {
    @if no-exmap($exmap) {@return ();}
    @return nth($exmap, 2);
}
/** exmap-get **/
@function exmap-get($exmap, $key) {
    @if no-str($key) or $key == '' {@return null;}
    @if is-map($exmap) {@return map-get($exmap, $key);}
    @if no-exmap($exmap) {@return null;}
    $i: exmap-index($exmap, $key);
    @if $i == null {@return null;}
    $vals: exmap-values($exmap);
    @return nth($vals, $i);
}
/** exmap-set 支持直接传入 原生 map 相当于 exmap-merge **/
@function exmap-set($exmap, $key, $val: null) {
    @if is-map($key) {@return exmap-merge($exmap, $key);}
    @if no-str($key) {@return $exmap;}
    $exmap: exmap-from($exmap);
    $keys: exmap-keys($exmap);
    $vals: exmap-values($exmap);
    $i: exmap-index($exmap, $key);
    @if $i == null {
        $keys: ex-append($keys, $key);
        $vals: ex-append($vals, $val);
    } @else {
        $vals: set-nth($vals, $i, $val);
    }
    @return exmap-quote(($keys, $vals));
}
/** exmap-remove **/
@function exmap-remove($exmap, $key) {
    @if no-str($key) {@return $exmap;}
    $exmap: exmap-from($exmap);
    @if exmap-has-key($exmap, $key) != true {@return $exmap;}
    $keys: exmap-keys($exmap);
    $vals: exmap-values($exmap);
    $i: exmap-index($exmap, $key);
    $keys: del-nth($keys, $i);
    $vals: del-nth($vals, $i);
    @return exmap-quote(($keys, $vals));
}
//exmap-merge 返回：exmap
@function exmap-merge($map-a, $map-b) {
    @if is-map($map-a) and is-map($map-b) {
        $map-a: map-merge($map-a, $map-b);
        @return exmap-from($map-a);
    }
    $map-a: exmap-from($map-a);
    $map-b: exmap-from($map-b);
    $isem-a: exmap-is-empty($map-a);
    $isem-b: exmap-is-empty($map-b);
    @if $isem-a == true and $isem-b == true {@return exmap-mk();}
    @if $isem-a == true {@return $map-b;}
    @if $isem-b == true {@return $map-a;}
    $keys-b: exmap-keys($map-b);
    $vals-b: exmap-values($map-b);
    $rtn: $map-a;
    @for $i from 1 through length($keys-b) {
        $k: nth($keys-b, $i);
        $v: nth($vals-b, $i);
        $rtn: exmap-set($rtn, $k, $v);
    }
    @return $rtn;
}
/**
    根据传入的 key-list 从 exmap 中筛选出对应的 键值对，创建为新的 exmap
    filter-keys($exmap, (key,foo-bar, ...)) 将会筛选出所有 键名前缀为指定值的 键值对：new-exmap: (
        //keys list
        (key,key-foo,key-bar, foo-bar,foo-bar-jaz, ...),
        //values list
        ( ... )
    )
**/
@function exmap-filter-keys($exmap, $finds, $prefix: true) {
    @if no-list($finds) or is-empty($finds) {@return exmap-mk();}
    $exmap: exmap-from($exmap);
    @if exmap-is-empty($exmap) {@return exmap-mk();}
    $oks: exmap-keys($exmap);
    $ovs: exmap-values($exmap);
    $keys: ();
    $vals: ();
    @each $k in $finds {
        $kpre: $k + '-';
        $klen: str-length($kpre);
        @for $i from 1 through length($oks) {
            $oki: nth($oks, $i);
            $ovi: nth($ovs, $i);
            @if $prefix == true {
                $opre: if(str-length($oki) < $klen, $oki, str-slice($oki, 1, $klen));
            }
            @if $oki == $k or ($prefix == true and $opre == $kpre) {
                $keys: ex-append($keys, $oki);
                $vals: ex-append($vals, $ovi);
            }
        }
    }
    @return exmap-quote(($keys, $vals));
}





// @debug 方法

@mixin debug($map: ()) {
    $cnt: '';
    @each $k in map-keys($map) {
        $v: map-get($map, $k);
        $cnt: $cnt + $k + ': ' + $v + ' ('+ type-of($v) + ') | ';
    }
    content: '#{$cnt}';
}
.scssphp-patcher-types {
    @include debug((
        //ta: type-of(100px),
        //tb: type-of('100'),
        //tc: type-of(()),
        //td: type-of(true),
        tpl: index($scssTypeList, 'null'),
        is-null: is-null(null),
        tpof: type-of(null),
        isa: isa(null, 'null'),
        tpofb: type-of(null) == 'null',
        te: to-string(100px),
        tf: to-number('100px'),
        is-digit: is-digit(100),
        is-digit-a: is-digit(100px),
        is-hex: is-hex(ff),
        is-hex-a: is-hex(88),
        to-dec: to-dec(ff),
        to-dec-a: to-dec(88),
        to-str: to-string(99),
        to-hex: to-hex(-255),
        to-hex-a: to-hex(65536),    //10000
        to-dec-b: to-dec(10000),    //65536
    ));
}
.scssphp-patcher-syntax {
    $u: vw;
    @include debug((
        sa: if(true, true-val, false-val),
        sb: 100 * 1px,
        sc: 100 * 1#{$u},
        sci: set-unit(100, $u),
        sd: '100px' * 1,
        se: 100px + '',
        sf: 100px * 2,
        sfi: 100px / 2,
        sg: 100px + 20px,
        sgi: 100px - 20px,
        sh: 100px / 1px,
        shi: 100px * 1px,
        shj: 100mm * 2in,
        si: 100px % 2px,
        sj: 100px % 50 == 0,
        sn: 100px % 50 == 0px,
        sk: 100#{$u} + 20#{$u},
        sl: '100' * 1,
    ));
}
.scssphp-patcher-string {
    $str: padding;
    @include debug((
        sa: str-insert($str, -left, str-length($str)+1),
        sb: str-replace($str, d, b),
        sc: str-trim(' foo bar '),
        sd: str-index($str, d),
        se: unique-id(),
        sf: str-split(margin-right, '-'),
        sfi: str-split(margin-right, 'ig'),
        sfj: str-split('foobarfoobar', 'ob'),
        sg: to-string(100px),
        sh: to-string(100),
        si: to-string(false),
        sj: to-string(()),
        sk: to-string(null),
        sl: to-string(padding),
        si: str-split(btn-m, '-'),
        sii: str-split(btn-m, 'kk'),
        sik: str-split(btn-m, ''),
        sj: str-trim(' foo bar jaz  '),
        str-number: str-number('ff', 16),
        to-upper: to-upper-case('Foobar'),
        to-lower: to-lower-case(Foobar),
        str-lower: str-lower('background-Color'),
        str-camel: str-camel(btn-xl),
        str-kebab: str-kebab(BackgroundColor),
    ));
}
.scssphp-patcher-number {
    $n: 100px;
    $u: px;
    @include debug((
        na: ex-ceil(-5.1px),
        nb: ex-floor('5.1em'),
        //nc: round(5.1),
        nd: ex-round('-5.7px'),
        //ne: abs(-100),
        nf: ex-abs('-200px'),
        //ng: pow(10, 3),
        nh: 100 * 1#{$u},
        ni: ex-clamp(10px, 20px, 15px),
        //nj: comparable(100px, 20vw),
        //nk: unitless(100px),
        nl: min(10px, 50px),
        nm: max(10px, 50px),
        nn: strip-unit(100px),
        no: to-number('100px'),
        np: to-number(100px),
        nq: to-number(100),
        nr: to-number('100'),
        ns: to-number(()),
        nt: to-number(true),
        nu: to-number(btn-m btn-xl),
        nv: to-digit('100px'),
        nw: is-num('100px'),
        nx: no-num('100px'),
        ny: min(10px),
        nz: min(10px, 20px),
        ma: max(10cm, 20mm),
        mb: ex-clamp(1cm, 1in, 2cm),
        mi: ex-clamp(1cm, 1in, 2.54cm),
        mc: to-digit('12.'),
        md: to-digit('0.3876'),
        me: to-digit('.3'),
        mf: is-numeric('.3s', true),
        mg: to-number('16.666666%'),
        mh: to-number(3.14px),
        mi: is-numeric('-.9px', true),
        mj: is-digit('-.9'),
        mk: to-digit('-.9'),
        add: add(10px, '-20px'),
        dif: dif(10px, 5),
        mul: mul(10px, -2),
        div: div(10px, 2em),
    ));
}
.scssphp-patcher-color {
    //$c: #fb7a7a88;
    $c: rgba(251, 122, 122, 1);
    $r: red($c);
    $g: green($c);
    $b: blue($c);
    $h: hue($c);
    $s: saturation($c);
    $l: lightness($c);
    $a: alpha($c);
    $c2: #4ca2f2;
    @include debug((
        ex-c1: ex-color(255 128 128),
        ex-c2: ex-color(rgb 255 255 255),
        ex-c3: ex-color(hsl 10 75% 62%, 0.9),
        ex-c4: ex-color(hsl 10 75% 68.888888%),
        ex-c5: ex-color(#fb7a7a),
        ex-c6: ex-color(#fb7a7a80, 0.3),
        ex-c7: ex-color('#fb7a7a'),
        ex-c8: ex-color('#fb7a7a80', 0.3),
        ex-c9: ex-darken(#fb7a7a, -6),
        ex-c10: color-shift-mapper(#fb7a7a, 3, 15%, btn),
        front: front(#fb7a7a, 0.8),

        r: $r,
        g: $g,
        b: $b,
        h: $h,
        s: $s,
        l: $l,
        a: $a,
        rgb: rgb($r, $g, $b),
        rgba: rgba($r, $g, $b, $a),
        hsl: hsl($h, $s, $l),
        //hsla: hsla($h, $s, $l, $a),
        hsla: hsla(10, 75%, 62%, 0.9),
        hex: hex($c),
        rgb2: rgb($c),
        rgba2: rgba($c),
        hsl2: hsl($c),
        hsla2: hsla($c),
        lighten: lighten($c, 20%),
        darken: darken($c, 20%),
        scale-color-lighter: scale-color($c, $lightness: 20%),
        scale-color-darker: scale-color($c, $lightness: -20%),
        change-red: change-color($c, $red: 200),
        change-alpha: change-color($c, $alpha: 0.7),
        mix: mix($c, $c2, 70%),
        contrast: contrast($c),             //计算前景色
        invert: invert($c),                 //反色
        adjust-hue: adjust-hue($c, 30deg),  //色相环调整角度
        saturate: saturate($c, 20%),        //增加饱和度
        desaturate: desaturate($c, 20%),    //降低饱和度
        transparentize: transparentize($c, 0.6),    //增加透明度，--> 透明
        fade-out: fade-out($c, 0.6),
        opaquer: opaquer($c, 0.2),          //降低透明度，--> 不透明
        fade-in: fade-in($c, 0.2),
        to-string: to-string($c),
        rgb-to-string: to-string(rgb($c)),
        unquote: unquote('#{$c}'),
        color: color('#{$c}'),
    ));
}
.scssphp-patcher-list {
    $la: (100px 20px 30px);
    $lb: primary,danger,success;
    $lc: [];
    @include debug((
        la: append($la, 40px, space),
        lb: prepend($la, 40px, space),
        lc: list-separator($lb),
        ld: is-bracketed($lc),
        le: index($la, 20px),
        lf: set-nth($la, 2, 25px),
        lm: del-nth($la, 2),
        lg: join($la, $lb, comma),
        lh: flatten((100px, (20px, 30px), 40px)),
        li: slice($la, -1),
        lj: slice($la, 1, -1),
        lk: slice($la, 2, -2),
        ll: insert($la, $lb, -1),
        lm: mk('',''),
        ln: length(mk('','','','')),
        lo: mk(a,b,c),
    ));
}
.scssphp-patcher-map {
    $m: (
        btn-m: 10px,
        btn-xl: 12px,
        rd-m: 6px,
    );
    @include debug((
        ma: map-length($m),
        mb: map-get($m, btn-xl),
        mc: map-set($m, rd-m, 8px),
        md: map-remove($m, rd-m),
        me: map-has-key($m, rd-m),
        mf: map-keys($m),
        mg: map-values($m),
        mh: map-merge($m, (rd-s: 4px, fs-m: 14px)),
    ));
}
.scssphp-patcher-exmap {
    $m: exmap-from((
        btn-m: 10px,
        btn-xl: 12px,
        rd-m: 6px,
    ));
    @include debug((
        ma: exmap-length($m),
        mb: exmap-get($m, btn-xl),
        mc: exmap-set($m, rd-m, 8px),
        md: exmap-remove($m, rd-m),
        me: exmap-has-key($m, rd-m),
        mf: exmap-keys($m),
        mg: exmap-values($m),
        mh: exmap-merge($m, (rd-s: 4px, fs-m: 14px)),
        mhk: exmap-set($m, (rd-s: 8px, fs-m: 18px)),
        mi: exmap-filter-keys($m, (btn)),
        mj: exmap-mk(),
    ));
}
